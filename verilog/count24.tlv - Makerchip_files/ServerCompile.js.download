(function(){var $,EventEmitter,NewServerCompile,Promise,RetroServerCompile,ServerCompile,ServerCompileWrapper,WaveData,io,boundMethodCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new Error('Bound instance method accessed before binding');}};[$,Promise,io,WaveData]=[];if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){Promise=require("bluebird");io=require("socket.io-client");}
ServerCompile=(function(){class ServerCompile{init(){throw new Error("Unimplemented method.");}
compile(tlv,cb){throw new Error("Unimplemented method.");}
showStats(){throw new Error("Unimplemented method.");}
showResults(){throw new Error("Unimplemented method.");}
compileAnalytics(){if(typeof window.ga!=="function"){return;}
return window.ga("send",{hitType:"event",eventCategory:"Projects",eventAction:"compile",eventValue:++this.sentCompilations});}};ServerCompile.prototype.sentCompilations=0;return ServerCompile;}).call(this);RetroServerCompile=(function(){class RetroServerCompile extends ServerCompile{constructor(){super(...arguments);this.error=this.error.bind(this);this.graph=this.graph.bind(this);this.jsonParseModel=this.jsonParseModel.bind(this);this.vcd=this.vcd.bind(this);this.navTLV=this.navTLV.bind(this);}
init(){return this.io().then(()=>{return this;});}
setProject(project){this.project=project;this.socket.on("newcompile",(id)=>{if(this.project.vcd){return this.emit("verilator/done",{success:"success"});}});return this.project.on("vcd",(vcd)=>{return this.emit("vcd",vcd);});}
compile(tlv,cb){var data,dot,sim;this.compileAnalytics();sim=true;dot=true;if(this.project!=null){sim=!this.project.vcd;}
data={source:tlv,sim:sim,dot:dot};return this.socket.emit("data",JSON.stringify(data),(lastId)=>{this.lastId=lastId;return cb(this.lastId);});}
showStats(){return window.open(`/compile/${this.lastNavTLV}/stats/`);}
showResults(){return window.open(`/compile/${this.lastNavTLV}/results/`);}
io(){var baseApi,ref;baseApi=(ref=window.BASE_API_URL)!=null?ref:"";return new Promise((resolve,reject)=>{this.socket=io(`${baseApi}/sandpiper/compile/`);this.socket.on("newcompile",(id)=>{this.emit("newcompile",{compile:id});return this.emit("m4/done",{compile:id});});this.socket.on("err",this.error);this.socket.on("graph",this.graph);this.socket.on("parse model",this.jsonParseModel);this.socket.on("vcd",this.vcd);this.socket.on("navTLV",this.navTLV);this.socket.on("stdall",(id,log)=>{if(id!==this.lastId){return;}
return this.emit("stdall/all",log);});this.socket.on("makeout",(id,log)=>{if(id!==this.lastId){return;}
return this.emit("makeout/all",log);});return resolve(this.socket);});}
error(type,id){boundMethodCheck(this,RetroServerCompile);if(id!==this.lastId){return;}
switch(type){case "graph":return this.emit("graphviz/done",{success:"failure"});case "graph-timeout":return this.emit("graphviz/done",{success:"failure",timeout:true});case "vcd":return this.emit("verilator/done",{success:"failure"});case "vcd-timeout":return this.emit("verilator/done",{success:"failure",timeout:true});case "compile":return this.emit("sandpiper/done",{success:"failure"});case "compile-timeout":return this.emit("sandpiper/done",{success:"failure",timeout:true});case "navtlv":return this.emit("navtlv/done",{success:"failure"});case "navtlv-timeout":return this.emit("navtlv/done",{success:"failure",timeout:true});}}
graph(id,graph){boundMethodCheck(this,RetroServerCompile);if(id!==this.lastId){return;}
if(graph===""){this.emit("graph",graph);return this.emit("graphviz/done",{success:"failure"});}else{this.emit("graph",graph);return this.emit("graphviz/done",{success:"success"});}}
jsonParseModel(id,json){boundMethodCheck(this,RetroServerCompile);if(id!==this.lastId){return;}
this.emit("parse model",JSON.parse(json));return this.emit("parse model/done",{success:"success"});}
vcd(id,vcd){boundMethodCheck(this,RetroServerCompile);if(id!==this.lastId){return;}
this.emit("vcd",new WaveData(vcd,true));return this.emit("verilator/done",{success:"success"});}
navTLV(id,navTLV){boundMethodCheck(this,RetroServerCompile);if(id!==this.lastId){return;}
this.lastNavTLV=id;this.emit("sandpiper/done",{success:"success"});return this.emit("navTLV",navTLV);}};RetroServerCompile.prototype.socket=null;RetroServerCompile.prototype.lastId=null;RetroServerCompile.prototype.lastNavTLV=null;RetroServerCompile.prototype.project=null;return RetroServerCompile;}).call(this);NewServerCompile=(function(){class NewServerCompile extends ServerCompile{constructor(){super(...arguments);this.get=this.get.bind(this);}
init(){return Promise.resolve(this.getEndpoint()).then((endpoint)=>{return this.endpoint=endpoint;}).then(()=>{return this.subscribe();});}
getEndpoint(){var baseApi,ref;baseApi=(ref=window.BASE_API_URL)!=null?ref:"";return $.get(`${baseApi}/results-endpoint/`);}
openSocket(){var baseApi,ref;baseApi=(ref=window.BASE_API_URL)!=null?ref:"";return io(`${baseApi}${this.endpoint}`);}
subscribe(){var gotStats,i,len,ref,stage;this.socket=this.openSocket();gotStats=(data)=>{if(data.compile!==this.currentCompile){return;}
return this.statCompile=data.compile;};ref=["m4","sandpiper-graph","graphviz","sandpiper","verilator"];for(i=0,len=ref.length;i<len;i++){stage=ref[i];this.socket.on(`${stage}/done`,(data)=>{if(data.compile!==this.currentCompile){return;}
return this.emit(`${data.stage}/done`,data);});}
this.socket.on("top.tlv/generated",gotStats);this.socket.on("top.tlv/output",gotStats);this.socket.on("top.tlv/stats",gotStats);this.socket.on("vcd",(data)=>{if(data.compile!==this.currentCompile){return;}
return this.get(`/compile/${data.compile}/simulation.vcd`).then((vcd)=>{return this.emit("vcd",new WaveData(vcd,true));});});this.socket.on("top.tlv/graph",(data)=>{if(data.compile!==this.currentCompile){return;}
return this.get(`/compile/${data.compile}/top.tlv/graph.svg`).then((graph)=>{return this.emit("graph",graph);});});this.socket.on("top.tlv/nav",(data)=>{if(data.compile!==this.currentCompile){return;}
return this.get(`/compile/${data.compile}/top.tlv/navigable.tlv.html`).then((nav)=>{return this.emit("navTLV",nav);});});this.socket.on("log/sandpiper",(data)=>{if(data.compile!==this.currentCompile){return;}
return this.emit("stdall",data);});this.socket.on("log/verilator",(data)=>{if(data.compile!==this.currentCompile){return;}
return this.emit("makeout",data);});return this;}
get(url){var base;boundMethodCheck(this,NewServerCompile);base=this.endpoint.replace(/\/$/,'');return Promise.resolve($.get(`${base}${url}`));}
compile(tlv,cb){var baseApi,project,ref;baseApi=(ref=window.BASE_API_URL)!=null?ref:"";this.compileAnalytics();project={files:{"top.tlv":{type:"file",contents:tlv}},metadata:{},settings:{}};return $.post(`${baseApi}/makerchip/compile/`,project).then(function(data){return cb(null,data);}).catch(function(err){return cb(err);});}
showStats(){if(!this.statCompile){throw new ServerCompile.NoSuccessfulCompile("No successful compile yet.");}
return window.open(`${this.endpoint}/compile/${this.successfulCompile}/top.tlv/stats/`);}
showResults(){if(!this.statCompile){throw new ServerCompile.NoSuccessfulCompile("No successful compile yet.");}
return window.open(`${this.endpoint}/compile/${this.successfulCompile}/top.tlv/`);}};NewServerCompile.prototype.endpoint="http://makerchip.com/results/";NewServerCompile.prototype.socket=null;NewServerCompile.prototype.currentCompile=null;NewServerCompile.prototype.statCompile=null;return NewServerCompile;}).call(this);ServerCompileWrapper=class ServerCompileWrapper extends ServerCompile{init(){return Promise.resolve(this.getEndpoint()).then((endpoint)=>{var implementation;implementation=endpoint==="RETRO"?RetroServerCompile:NewServerCompile;this.instance=new implementation();this.on=this.instance.on;this.emit=this.instance.emit;this.compile=()=>{return this.instance.compile(...arguments);};return this.instance.init();});}
getEndpoint(){var baseApi,ref;baseApi=(ref=window.BASE_API_URL)!=null?ref:"";return $.get(`${baseApi}/results-endpoint/`);}};if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){EventEmitter=require("events");ServerCompile.prototype=Object.assign(Object.create(EventEmitter.prototype),ServerCompile.prototype);NewServerCompile.prototype=Object.assign(Object.create(ServerCompile.prototype),NewServerCompile.prototype);RetroServerCompile.prototype=Object.assign(Object.create(ServerCompile.prototype),RetroServerCompile.prototype);ServerCompileWrapper.prototype=Object.assign(Object.create(ServerCompile.prototype),ServerCompileWrapper.prototype);module.exports={ServerCompile,RetroServerCompile,NewServerCompile,ServerCompileWrapper};}else{define("ServerCompile",function(require,exports,module){var Utils;$=require("jquery");Utils=require("Utils");Promise=require("bluebird");io=require("socket.io");EventEmitter=require("ServerCompile/eventemitter");WaveData=require("VCD");Utils.extend(ServerCompile,module.config());Utils.extend(ServerCompile,EventEmitter.prototype);Utils.extend(NewServerCompile,Object.create(ServerCompile.prototype),true);Utils.extend(RetroServerCompile,Object.create(ServerCompile.prototype),true);Utils.extend(ServerCompileWrapper,Object.create(ServerCompile.prototype),true);return ServerCompileWrapper;});}}).call(this);